// src/pages/GuidancePage.js
import React, { useEffect, useState } from "react";
import { collection, getDocs } from "firebase/firestore";
import { db } from "../firebase";
import BackToDashboardButton from "../components/BackToDashboardButton";

// Helper function to clean strings of bad characters
const sanitize = (str) => {
  if (typeof str !== "string") return "";
  return str.replace(/[\u0000-\u001F\u007F]/g, "").trim(); // Remove control chars
};

const GuidancePage = () => {
  const [guidanceDocs, setGuidanceDocs] = useState([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    const fetchGuidance = async () => {
      try {
        const snapshot = await getDocs(collection(db, "guidance"));
        const docsData = snapshot.docs.map((doc) => {
          const data = doc.data();
          return {
            id: doc.id,
            title: sanitize(data.title || "Untitled Document"),
            description: sanitize(
              data.description || "No description provided."
            ),
            pdfUrl: sanitize(data.pdfUrl || ""),
          };
        });
        setGuidanceDocs(docsData);
        setLoading(false);
      } catch (err) {
        console.error("Error fetching guidance docs:", err);
        setLoading(false);
      }
    };

    fetchGuidance();
  }, []);

  if (loading) {
    return <div className="p-6">Loading Guidance Notes...</div>;
  }

  return (
    <div className="p-6">
      <BackToDashboardButton />
      <h1 className="text-3xl font-bold text-blue-700 mb-4">Guidance Notes</h1>
      {guidanceDocs.length === 0 ? (
        <p>No guidance documents found.</p>
      ) : (
        <ul className="space-y-4">
          {guidanceDocs.map((doc) => (
            <li key={doc.id} className="bg-white p-4 rounded shadow">
              <h2 className="text-xl font-semibold text-blue-800 mb-1">
                {doc.title}
              </h2>
              <p className="text-sm text-gray-600 mb-2">{doc.description}</p>

              {/* Optional PDF viewer link */}
              {doc.pdfUrl && doc.pdfUrl.startsWith("https://") && (
                <a
                  href={doc.pdfUrl}
                  target="_blank"
                  rel="noopener noreferrer"
                  className="text-blue-600 hover:underline text-sm"
                >
                  View PDF
                </a>
              )}
            </li>
          ))}
        </ul>
      )}
    </div>
  );
};

export default GuidancePage;
